<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Catch the Box - Upgraded</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      text-align: center;
    }
    canvas {
      background: #222;
      display: block;
      margin: 20px auto;
      border: 3px solid #fff;
    }
    #mobile-controls {
      display: none;
      margin: 10px auto;
    }
    .btn {
      padding: 10px 20px;
      margin: 5px;
      font-size: 18px;
      background: #0f0;
      color: #000;
      border: none;
      border-radius: 5px;
    }
    #menu, #gameOver {
      display: none;
    }
  </style>
</head>
<body>
  <div id="menu">
    <h1>üéÆ Catch the Box!</h1>
    <p>Use ‚¨ÖÔ∏è ‚û°Ô∏è arrows or mobile buttons.</p>
    <button class="btn" onclick="startGame()">Start Game</button>
  </div>

  <div id="gameOver">
    <h1>Game Over üòµ</h1>
    <p id="finalScore"></p>
    <button class="btn" onclick="startGame()">Play Again</button>
  </div>

  <canvas id="gameCanvas" width="400" height="500"></canvas>

  <div id="mobile-controls">
    <button class="btn" onclick="keys['ArrowLeft'] = true; setTimeout(()=>keys['ArrowLeft'] = false, 100)">‚¨ÖÔ∏è</button>
    <button class="btn" onclick="keys['ArrowRight'] = true; setTimeout(()=>keys['ArrowRight'] = false, 100)">‚û°Ô∏è</button>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    let score = 0, highScore = 0, lives = 3;
    let gameRunning = false;

    const player = { x: 180, y: 460, width: 40, height: 20, speed: 5 };

    const keys = {};
    const boxes = [];

    const sounds = {
      catch: new Audio('https://freesound.org/data/previews/256/256113_3263906-lq.mp3'),
      miss: new Audio('https://freesound.org/data/previews/341/341695_5260879-lq.mp3')
    };

    function createBox() {
      return {
        x: Math.random() * 360,
        y: -20,
        size: 20,
        speed: 3 + Math.random() * 2,
        isBomb: Math.random() < 0.2
      };
    }

    function resetGame() {
      score = 0;
      lives = 3;
      boxes.length = 0;
      boxes.push(createBox());
      gameRunning = true;
      document.getElementById('menu').style.display = 'none';
      document.getElementById('gameOver').style.display = 'none';
      document.getElementById('mobile-controls').style.display = 'block';
    }

    function startGame() {
      resetGame();
      gameLoop();
    }

    function gameOver() {
      gameRunning = false;
      document.getElementById('finalScore').innerText = `Your score: ${score}. High Score: ${highScore}`;
      document.getElementById('gameOver').style.display = 'block';
    }

    document.addEventListener('keydown', e => keys[e.key] = true);
    document.addEventListener('keyup', e => keys[e.key] = false);

    function update() {
      if (!gameRunning) return;

      // Movement
      if (keys['ArrowLeft']) player.x -= player.speed;
      if (keys['ArrowRight']) player.x += player.speed;

      player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));

      boxes.forEach(box => {
        box.y += box.speed;

        if (
          box.y + box.size >= player.y &&
          box.x + box.size >= player.x &&
          box.x <= player.x + player.width
        ) {
          if (box.isBomb) {
            lives--;
            sounds.miss.play();
          } else {
            score++;
            if (score > highScore) localStorage.setItem('highScore', score);
            sounds.catch.play();
          }
          Object.assign(box, createBox());
        }

        if (box.y > canvas.height) {
          if (!box.isBomb) {
            lives--;
            sounds.miss.play();
          }
          Object.assign(box, createBox());
        }
      });

      if (lives <= 0) {
        highScore = Math.max(score, highScore);
        gameOver();
      }

      if (Math.random() < 0.01) boxes.push(createBox());
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Player
      ctx.fillStyle = '#00f';
      ctx.fillRect(player.x, player.y, player.width, player.height);

      // Boxes
      boxes.forEach(box => {
        ctx.fillStyle = box.isBomb ? 'red' : 'lime';
        ctx.fillRect(box.x, box.y, box.size, box.size);
      });

      ctx.fillStyle = 'white';
      ctx.font = '18px Arial';
      ctx.fillText('Score: ' + score, 10, 20);
      ctx.fillText('Lives: ' + lives, 10, 40);

      highScore = localStorage.getItem('highScore') || 0;
      ctx.fillText('High Score: ' + highScore, 10, 60);
    }

    function gameLoop() {
      if (!gameRunning) return;
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    document.getElementById('menu').style.display = 'block';
  </script>
</body>
</html>
